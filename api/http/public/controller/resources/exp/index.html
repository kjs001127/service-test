<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
      body {
        margin: 0;
        width: 100%;
        height: 100vh;
      }
      #wam {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
      }
    </style>
  </head>
  <body>
    <script>
      function flattenObject(obj) {
        const result = {};

        for (const key in obj) {
          if (obj.hasOwnProperty(key)) {
            if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) {
              for (const nestedKey in obj[key]) {
                if (obj[key].hasOwnProperty(nestedKey)) {
                  result[nestedKey] = obj[key][nestedKey];
                }
              }
            } else {
              result[key] = obj[key];
            }
          }
        }

        return result;
      }
    </script>
    <script>
      const wamData = (() => {
        try {
          const searchParams = new URLSearchParams(window.location.search)
          const decodedWamData = searchParams.get('wam_data')
          const parsedWamData = JSON.parse(decodedWamData)
          const flattenedWamData = flattenObject(parsedWamData)
          return flattenedWamData
        } catch (e) {
          return {}
        }
      })()

      const baseDropWizardUrl = 'https://api.exp.channel.io'
      const baseAppStoreUrl = 'https://app-store-api.exp.channel.io'

      function sendToClient(wamEvent) {
        if (
          window.channelMobileWamController &&
          typeof window.channelMobileWamController.postMessage === 'function'
        ) {
          window.channelMobileWamController.postMessage(JSON.stringify(wamEvent))
          return
        }
      
        if (
          window.webkit &&
          window.webkit.messageHandlers &&
          window.webkit.messageHandlers.channelMobileWamController &&
          typeof window.webkit.messageHandlers.channelMobileWamController.postMessage === 'function'
        ) {
          window.webkit.messageHandlers.channelMobileWamController.postMessage(wamEvent)
          return
        }

        if (
          window.parent &&
          window.parent.postMessage &&
          typeof window.parent.postMessage === 'function'
        ) {
          window.parent.postMessage(wamEvent, '*')
        }
      }

      function close({ appId, name, params = {} } = {}) {
        const wamEvent = appId && name ? {
          type: 'command',
          wamId: wamData.wamId,
          attributes: {
            appId,
            name,
            params,
          }
        } : null

        sendToClient({
          type: 'close',
          wamId: wamData.wamId,
          attributes: {
            wamEvent,
          }
        })
      }

      function callCommand({ appId, name, params = {} } = {}) {
        sendToClient({
          type: 'command',
          wamId: wamData.wamId,
          attributes: {
            appId,
            name,
            params,
          }
        })
      }

      function setSize({ width, height }) {
        sendToClient({
          type: 'setSize',
          wamId: wamData.wamId,
          attributes: {
            width,
            height,
          }
        })
      }

      function refreshAuthToken() {
        return fetch(`${baseDropWizardUrl}/general/auth/v1/token?grant_type=refresh_token&refresh_token=${wamData.refreshToken}`, {
          method: 'POST',
          headers: {
            'accept': 'application/json',
            'Content-Type': 'application/x-www-form-urlencoded',
          },
        })
        .then(response => response.json())
      }

      function callFunction({ appId, name, params = {} } = {}) {
        return fetch(`${baseAppStoreUrl}/general/v1/apps/${appId}/functions`, {
          method: 'PUT',
          body: JSON.stringify({
            method: name,
            params,
            context: {
              channel: {
                id: wamData.channelId,
              }
            }
          }),
          headers: {
            'x-access-token': wamData.accessToken,
            'accept': 'application/json',
            'Content-Type': 'application/json',
          }
        })
        .then(response => {
          if (!response.ok) {
            return response.json().then((error) => {
              return refreshAuthToken()
                .then((result) => {
                  if (result && result.access_token && result.refresh_token) {
                    wamData.accessToken = result.access_token
                    wamData.refreshToken = result.refresh_token

                    sendToClient({
                      type: 'onAuthTokenUpdated',
                      attributes: result,
                    })
                    return callFunction({ appId, name, params })
                  }
                })
            })
          }

          return response.json()
        })
      }

      function callNativeFunction({ name, params = {}}) {
        return fetch(`${baseAppStoreUrl}/general/v1/native/functions`, {
          method: 'PUT',
          body: JSON.stringify({
            method: name,
            params,
          }),
          headers: {
            'x-access-token': wamData.accessToken,
            'accept': 'application/json',
            'Content-Type': 'application/json',
          }
        })
        .then(response => {
          if (!response.ok) {
            return response.json().then((error) => {
              return refreshAuthToken()
                .then((result) => {
                  if (result && result.access_token && result.refresh_token) {
                    wamData.accessToken = result.access_token
                    wamData.refreshToken = result.refresh_token

                    sendToClient({
                      type: 'onAuthTokenUpdated',
                      attributes: result,
                    })
                    return callNativeFunction({ name, params })
                  }
                })
            })
          }

          return response.json()
        })
      }

      function getWamData(key) {
        return wamData[key]
      }

      function loadWam() {
        const wamIframe = document.createElement('iframe')
        wamIframe.id = 'wam'
        wamIframe.src = `${baseAppStoreUrl}/public/v1/apps/${wamData.appId}/wams/${wamData.wamName}/`
        document.body.appendChild(wamIframe)

        wamIframe.contentWindow.close = close
        wamIframe.contentWindow.callCommand = callCommand
        wamIframe.contentWindow.setSize = setSize
        wamIframe.contentWindow.callFunction = callFunction
        wamIframe.contentWindow.callNativeFunction = callNativeFunction
        wamIframe.contentWindow.getWamData = getWamData
      }

      window.onload = loadWam
    </script>
  </body>
</html>
