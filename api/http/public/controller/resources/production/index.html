<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
      body {
        margin: 0;
        width: 100%;
        height: 100vh;
      }
      #wam {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 30px 30px 0 0;
        display: block;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <script>
      function flattenObject(obj) {
        const result = {};

        for (const key in obj) {
          if (obj.hasOwnProperty(key)) {
            if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) {
              for (const nestedKey in obj[key]) {
                if (obj[key].hasOwnProperty(nestedKey)) {
                  result[nestedKey] = obj[key][nestedKey];
                }
              }
            } else {
              result[key] = obj[key];
            }
          }
        }

        return result;
      }
    </script>
    <script>
      const wamData = (() => {
        try {
          const searchParams = new URLSearchParams(window.location.search)
          const decodedWamData = searchParams.get('wam_data')
          const parsedWamData = JSON.parse(decodedWamData)
          const flattenedWamData = flattenObject(parsedWamData)
          return flattenedWamData
        } catch (e) {
          return {}
        }
      })()

      const channelId = wamData.channelId
      const appId = wamData.appId
      const wamName = wamData.wamName
      const wamId = wamData.wamId
      const accessToken = wamData.accessToken
      const refreshToken = wamData.refreshToken

      function sendToClient(wamEvent) {
        if (
          window.channelMobileWamController &&
          typeof window.channelMobileWamController.postMessage === 'function'
        ) {
          window.channelMobileWamController.postMessage(JSON.stringify(wamEvent))
          return
        }
      
        if (
          window.webkit &&
          window.webkit.messageHandlers &&
          window.webkit.messageHandlers.channelMobileWamController &&
          typeof window.webkit.messageHandlers.channelMobileWamController.postMessage === 'function'
        ) {
          window.webkit.messageHandlers.channelMobileWamController.postMessage(wamEvent)
          return
        }

        if (
          window.parent &&
          window.parent.postMessage &&
          typeof window.parent.postMessage === 'function'
        ) {
          window.parent.postMessage(wamEvent, '*')
        }
      }

      function close({ appId, name, params = {} } = {}) {
        const wamEvent = appId && name ? {
          type: 'command',
          wamId,
          attributes: {
            appId,
            name,
            params,
          }
        } : null

        sendToClient({
          type: 'close',
          wamId,
          attributes: {
            wamEvent,
          }
        })
      }

      function callCommand({ appId, name, params = {} } = {}) {
        sendToClient({
          type: 'command',
          wamId,
          attributes: {
            appId,
            name,
            params,
          }
        })
      }

      function setSize({ width, height }) {
        sendToClient({
          type: 'setSize',
          wamId,
          attributes: {
            width,
            height,
          }
        })
      }

      function callFunction({ appId, name, params = {} } = {}) {
        return fetch(`https://app-store-api.channel.io/general/v1/apps/${appId}/functions`, {
          method: 'PUT',
          body: JSON.stringify({
            method: name,
            params,
            context: {
              channel: {
                id: channelId,
              }
            }
          }),
          headers: {
            'x-access-token': accessToken,
            'accept': 'application/json',
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
      }

      function getWamData(key) {
        return wamData[key]
      }

      function loadWam() {
        const wamIframe = document.createElement('iframe')
        wamIframe.id = 'wam'
        wamIframe.src = `https://app-store-api.channel.io/public/v1/apps/${appId}/wams/${wamName}/`
        document.body.appendChild(wamIframe)

        wamIframe.contentWindow.close = close
        wamIframe.contentWindow.callCommand = callCommand
        wamIframe.contentWindow.setSize = setSize
        wamIframe.contentWindow.callFunction = callFunction
        wamIframe.contentWindow.getWamData = getWamData
      }

      window.onload = loadWam
    </script>
  </body>
</html>
